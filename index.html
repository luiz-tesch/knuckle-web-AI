<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Knucklebones</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    /* â”€â”€ RESET & VARIABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --gold:       #c9a84c;
      --gold-light: #e8c97a;
      --deep:       #0a0806;
      --card:       #13100a;
      --cream:      #e8dfc8;
    }

    body {
      font-family: 'Crimson Text', serif;
      background-color: var(--deep);
      color: var(--cream);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px),
        radial-gradient(ellipse at 50% 50%, #0d1a0f 0%, #06100a 60%, #020804 100%);
      pointer-events: none;
      z-index: 0;
    }

    /* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .screen {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 24px;
      gap: 32px;
      position: relative;
      z-index: 1;
      animation: fadeIn 0.4s ease;
    }
    .screen.active { display: flex; }

    #screen-game {
      justify-content: flex-start;
      padding: 16px;
      gap: 12px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* â”€â”€ TYPOGRAPHY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cinzel { font-family: 'Cinzel Decorative', cursive; }

    .title-sub {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.7rem;
      letter-spacing: 0.3em;
      color: rgba(201,168,76,0.6);
      text-align: center;
      margin-bottom: 18px;
    }

    .title-main {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 3.5rem;
      font-weight: 900;
      color: var(--gold);
      line-height: 1;
      text-align: center;
      text-shadow: 0 0 40px rgba(201,168,76,0.5);
    }

    @media (min-width: 480px) {
      .title-main { font-size: 4.5rem; }
    }

    /* â”€â”€ ORNAMENT DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ornament {
      display: flex;
      align-items: center;
      gap: 12px;
      color: rgba(201,168,76,0.4);
      font-size: 1rem;
      width: 100%;
    }
    .ornament::before, .ornament::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(201,168,76,0.4), transparent);
    }

    /* â”€â”€ CARD PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .panel {
      border: 1px solid var(--gold);
      box-shadow: 0 0 12px rgba(201,168,76,0.15), inset 0 0 12px rgba(0,0,0,0.4);
      background: rgba(0,0,0,0.4);
      padding: 32px;
      width: 100%;
      max-width: 360px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .panel-center {
      text-align: center;
      padding: 40px;
      gap: 24px;
    }

    /* â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .field { display: flex; flex-direction: column; gap: 8px; }

    .field-label {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      color: rgba(201,168,76,0.7);
    }

    .game-input {
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(201,168,76,0.4);
      color: var(--cream);
      padding: 10px 16px;
      font-family: 'Crimson Text', serif;
      font-size: 1.1rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    .game-input:focus {
      border-color: var(--gold);
      box-shadow: 0 0 10px rgba(201,168,76,0.2);
    }
    .game-input::placeholder { color: rgba(232,223,200,0.3); }
    .game-input.code-style {
      text-transform: uppercase;
      letter-spacing: 0.2em;
      text-align: center;
      font-size: 1.3rem;
    }

    /* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn-gold {
      background: linear-gradient(135deg, #c9a84c, #a07830);
      color: #0a0806;
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 12px 28px;
      border: none;
      cursor: pointer;
      letter-spacing: 0.1em;
      transition: box-shadow 0.2s, transform 0.2s;
      position: relative;
      overflow: hidden;
      width: 100%;
    }
    .btn-gold::before {
      content: '';
      position: absolute;
      top: 0; left: -100%;
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.4s;
    }
    .btn-gold:hover::before { left: 100%; }
    .btn-gold:hover { box-shadow: 0 0 20px rgba(201,168,76,0.5); transform: translateY(-1px); }
    .btn-gold:active { transform: translateY(0); }
    .btn-gold:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .btn-outline {
      background: transparent;
      color: var(--gold);
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 10px 24px;
      border: 1px solid var(--gold);
      cursor: pointer;
      letter-spacing: 0.08em;
      transition: background 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    .btn-outline:hover {
      background: rgba(201,168,76,0.1);
      box-shadow: 0 0 12px rgba(201,168,76,0.3);
    }
    .btn-outline.sm {
      font-size: 0.6rem;
      padding: 8px 16px;
      opacity: 0.8;
    }

    /* â”€â”€ WAITING SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .room-code-display {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 3.5rem;
      font-weight: 900;
      color: #fef08a;
      letter-spacing: 0.15em;
      text-shadow: 0 0 20px rgba(201,168,76,0.6);
    }

    .waiting-label {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.65rem;
      letter-spacing: 0.2em;
      color: rgba(201,168,76,0.7);
    }

    .waiting-title {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 1.8rem;
      color: var(--gold);
    }

    /* â”€â”€ STATUS / DOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .status-msg {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.65rem;
      letter-spacing: 0.12em;
      text-align: center;
      min-height: 1.5em;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      display: inline-block;
      flex-shrink: 0;
    }
    .dot-green  { background: #4ade80; box-shadow: 0 0 6px #4ade80; }
    .dot-yellow { background: #fbbf24; box-shadow: 0 0 6px #fbbf24; animation: blink 1s infinite; }

    @keyframes blink {
      0%, 100% { opacity: 1; } 50% { opacity: 0.3; }
    }

    .hint-text {
      font-size: 0.85rem;
      color: rgba(201,168,76,0.35);
      text-align: center;
      max-width: 280px;
    }

    /* â”€â”€ GAME SCREEN LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .game-header {
      width: 100%;
      max-width: 520px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
    }

    .game-header-label {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.6rem;
      letter-spacing: 0.15em;
      color: rgba(201,168,76,0.35);
    }

    .board-section { width: 100%; max-width: 520px; }

    .player-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .player-row.bottom { margin-bottom: 0; margin-top: 8px; }

    .player-name-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-name {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.8rem;
      color: var(--gold);
    }

    .score-display {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 1.8rem;
      color: var(--gold);
    }

    .board-wrap {
      border: 1px solid var(--gold);
      box-shadow: 0 0 12px rgba(201,168,76,0.15), inset 0 0 12px rgba(0,0,0,0.4);
      background: rgba(0,0,0,0.3);
      padding: 16px;
      border-radius: 4px;
    }

    .board-grid {
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    /* â”€â”€ CENTER TURN AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .turn-area {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
    }

    .turn-status {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.65rem;
      letter-spacing: 0.12em;
      text-align: center;
      min-height: 1.4em;
      color: var(--gold-light);
    }

    .sub-status {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.6rem;
      letter-spacing: 0.1em;
      text-align: center;
      min-height: 1.2em;
      color: rgba(201,168,76,0.5);
    }

    .rules-hint {
      width: 100%;
      max-width: 520px;
      text-align: center;
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.55rem;
      letter-spacing: 0.05em;
      color: rgba(201,168,76,0.25);
      margin-top: 4px;
    }

    /* â”€â”€ BOARD COLUMNS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .board-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .board-col.selectable { cursor: pointer; }
    .board-col.selectable:hover .die.empty {
      border-color: rgba(201,168,76,0.5);
      background: rgba(201,168,76,0.05);
    }

    .col-score {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.7rem;
      color: var(--gold-light);
      text-align: center;
      min-width: 56px;
      min-height: 18px;
    }

    /* â”€â”€ DICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .die {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #f5f0e8 0%, #d4cbb8 100%);
      border-radius: 10px;
      border: 2px solid rgba(0,0,0,0.3);
      box-shadow: 3px 3px 8px rgba(0,0,0,0.6), inset -2px -2px 4px rgba(0,0,0,0.2), inset 2px 2px 4px rgba(255,255,255,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      font-weight: 900;
      color: #1a1a1a;
      transition: all 0.2s;
      cursor: default;
      font-family: 'Cinzel Decorative', cursive;
    }

    .die.empty {
      background: rgba(0,0,0,0.3);
      border: 2px dashed rgba(201,168,76,0.2);
      box-shadow: none;
    }

    .die.val-high { background: linear-gradient(135deg, #fef3c7, #fde68a); }
    .die.val-mid  { background: linear-gradient(135deg, #f5f0e8, #d4cbb8); }
    .die.val-low  { background: linear-gradient(135deg, #e8e0d0, #c8bfaa); }

    /* Rolling die (center display) */
    .rolling-die {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #f5f0e8, #d4cbb8);
      border-radius: 10px;
      border: 3px solid var(--gold);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      font-weight: 900;
      color: #1a1a1a;
      font-family: 'Cinzel Decorative', cursive;
      box-shadow: 0 0 25px rgba(201,168,76,0.6);
      animation: floatdie 2s ease-in-out infinite;
    }

    @keyframes floatdie {
      0%, 100% { transform: translateY(0) rotate(-5deg); }
      50%       { transform: translateY(-8px) rotate(5deg); }
    }

    @keyframes pulse-gold {
      0%, 100% { box-shadow: 3px 3px 8px rgba(0,0,0,0.6), 0 0 8px  rgba(201,168,76,0.3); }
      50%       { box-shadow: 3px 3px 8px rgba(0,0,0,0.6), 0 0 18px rgba(201,168,76,0.6); }
    }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: var(--card);
      border: 1px solid var(--gold);
      padding: 12px 24px;
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.65rem;
      letter-spacing: 0.1em;
      color: var(--gold-light);
      z-index: 1000;
      transition: transform 0.3s ease;
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
      white-space: nowrap;
    }
    #toast.show { transform: translateX(-50%) translateY(0); }

    /* â”€â”€ WINNER OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #winner-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.88);
      z-index: 500;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 24px;
    }
    #winner-overlay.active { display: flex; animation: fadeIn 0.6s ease; }

    .trophy { font-size: 5rem; animation: trophy-anim 1s ease-out; }
    @keyframes trophy-anim {
      0%   { transform: scale(0) rotate(-20deg); opacity: 0; }
      70%  { transform: scale(1.2) rotate(5deg); }
      100% { transform: scale(1) rotate(0);      opacity: 1; }
    }

    .winner-title {
      font-family: 'Cinzel Decorative', cursive;
      font-size: 1.6rem;
      color: #fef08a;
      text-align: center;
    }

    .winner-scores {
      font-size: 1.1rem;
      color: #fef9e7;
      text-align: center;
    }

    /* â”€â”€ ERROR BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #peerjs-error {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0;
      color: #fde68a;
      font-family: 'Cinzel Decorative', cursive;
      font-size: 0.6rem;
      text-align: center;
      padding: 10px 16px;
      background: rgba(139,26,26,0.95);
      border-bottom: 1px solid #f87171;
      z-index: 900;
      letter-spacing: 0.08em;
    }
    #peerjs-error.active { display: block; }

    /* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--deep); }
    ::-webkit-scrollbar-thumb { background: var(--gold); }

    /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 480px) {
      .die, .rolling-die { width: 44px; height: 44px; font-size: 1.1rem; }
      .col-score { min-width: 44px; font-size: 0.6rem; }
      .title-main { font-size: 2.8rem; }
      .panel { padding: 24px; }
    }
  </style>
</head>
<body>

<div id="toast"></div>
<div id="peerjs-error">âš  Erro ao carregar biblioteca P2P. Verifique sua conexÃ£o e recarregue a pÃ¡gina.</div>

<!-- Winner Overlay -->
<div id="winner-overlay">
  <div class="trophy" id="trophy-emoji">ğŸ†</div>
  <div class="winner-title" id="winner-text"></div>
  <div class="winner-scores" id="winner-scores"></div>
  <div style="display:flex;flex-direction:column;align-items:center;gap:10px;margin-top:8px">
    <button class="btn-gold" style="width:auto" onclick="requestRematch()">âš” REVANCHE</button>
    <div id="rematch-status" style="font-family:'Cinzel Decorative',cursive;font-size:0.6rem;letter-spacing:0.1em;color:#e8c97a;min-height:1.2em"></div>
    <button id="rematch-btn-opp" class="btn-outline" style="width:auto;display:none" onclick="acceptRematch()">âœ“ ACEITAR REVANCHE</button>
    <button class="btn-outline sm" style="width:auto" onclick="resetGame()">â† SAIR</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOBBY SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-lobby" class="screen active">

  <div style="text-align:center">
    <div class="title-sub">âš” JOGO DE DADOS âš”</div>
    <h1 class="title-main">KNUCKLE<br>BONES</h1>
    <div class="ornament" style="margin-top:16px">âœ¦</div>
  </div>

  <div class="panel">

    <div class="field">
      <label for="player-name" class="field-label">SEU NOME</label>
      <input id="player-name" type="text" maxlength="16" placeholder="Como vocÃª se chama?" class="game-input" />
    </div>

    <div class="ornament">ou</div>

    <button class="btn-gold" onclick="createRoom()">âœ¦ CRIAR SALA PRIVADA</button>

    <div class="ornament">ou</div>

    <div class="field">
      <label for="room-code" class="field-label">CÃ“DIGO DA SALA</label>
      <input id="room-code" type="text" maxlength="8" placeholder="Ex: AB3X" class="game-input code-style" />
      <button class="btn-outline" onclick="joinRoom()">ENTRAR NA SALA â†’</button>
    </div>

  </div>

  <p class="hint-text">Jogo local P2P â€” compartilhe o cÃ³digo com seu amigo. Sem servidores externos.</p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     WAITING SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-waiting" class="screen">

  <div class="waiting-title cinzel">SALA CRIADA</div>

  <div class="panel panel-center">
    <div class="waiting-label">CÃ“DIGO DA SALA</div>
    <div class="room-code-display" id="display-room-code"></div>
    <button class="btn-outline" onclick="copyCode()">ğŸ“‹ COPIAR CÃ“DIGO</button>
    <div class="ornament">âœ¦</div>
    <div class="status-msg" style="color:rgba(201,168,76,0.7)">
      <span class="dot dot-yellow"></span>Aguardando oponente entrar...
    </div>
  </div>

  <button class="btn-outline sm" style="width:auto" onclick="backToLobby()">â† VOLTAR</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-game" class="screen">

  <!-- Header -->
  <div class="game-header">
    <span class="game-header-label">KNUCKLEBONES</span>
    <span class="game-header-label" id="room-label"></span>
  </div>

  <!-- Opponent board -->
  <div class="board-section">
    <div class="player-row">
      <div class="player-name-wrap">
        <span class="dot dot-green" id="opp-dot"></span>
        <span class="player-name" id="opp-name-display">Oponente</span>
      </div>
      <span class="score-display" id="opp-score">0</span>
    </div>
    <div class="board-wrap">
      <div class="board-grid" id="opp-board"></div>
    </div>
  </div>

  <!-- Turn area -->
  <div class="turn-area">
    <div class="turn-status" id="turn-status"></div>
    <div id="rolling-die-container"></div>
    <div class="sub-status" id="sub-status"></div>
  </div>

  <!-- My board -->
  <div class="board-section">
    <div class="board-wrap">
      <div class="board-grid" id="my-board"></div>
    </div>
    <div class="player-row bottom">
      <div class="player-name-wrap">
        <span class="dot dot-green"></span>
        <span class="player-name" id="my-name-display">VocÃª</span>
      </div>
      <span class="score-display" id="my-score">0</span>
    </div>
  </div>

  <div class="rules-hint">
    DADOS IGUAIS NA MESMA COLUNA MULTIPLICAM â€¢ MESMO NÃšM. CANCELA DO OPONENTE
  </div>

</div>

<!-- PeerJS com fallback -->
<script>
  (function() {
    var s = document.createElement('script');
    s.src = 'https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js';
    s.onerror = function() {
      var f = document.createElement('script');
      f.src = 'https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js';
      f.onerror = function() { document.getElementById('peerjs-error').classList.add('active'); };
      document.body.appendChild(f);
    };
    document.body.appendChild(s);
  })();
</script>

<script>
// â”€â”€ GAME STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLS = 3, ROWS = 3;
let myName = '', oppName = '';
let myBoard = [], oppBoard = [];
let myTurn = false, currentDie = null;
let peer = null, conn = null;
let isHost = false, roomCode = '', gameStarted = false;
let rematchRequestedByMe = false;

// â”€â”€ AUDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const AC = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
  if (AC.state === 'suspended') AC.resume();
  const g = AC.createGain();
  g.connect(AC.destination);

  if (type === 'roll') {
    // Rattle curto â€” dado girando
    for (let i = 0; i < 4; i++) {
      const o = AC.createOscillator();
      const og = AC.createGain();
      o.connect(og); og.connect(AC.destination);
      o.type = 'square';
      o.frequency.setValueAtTime(180 + Math.random()*120, AC.currentTime + i*0.07);
      og.gain.setValueAtTime(0.08, AC.currentTime + i*0.07);
      og.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + i*0.07 + 0.06);
      o.start(AC.currentTime + i*0.07);
      o.stop(AC.currentTime + i*0.07 + 0.07);
    }
  }

  if (type === 'place') {
    // Clique sÃ³lido â€” dado pousando na mesa
    const o = AC.createOscillator();
    const og = AC.createGain();
    o.connect(og); og.connect(AC.destination);
    o.type = 'sine';
    o.frequency.setValueAtTime(260, AC.currentTime);
    o.frequency.exponentialRampToValueAtTime(80, AC.currentTime + 0.08);
    og.gain.setValueAtTime(0.3, AC.currentTime);
    og.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + 0.12);
    o.start(AC.currentTime);
    o.stop(AC.currentTime + 0.13);
  }

  if (type === 'cancel') {
    // Estalo agressivo â€” dado do oponente sendo removido
    const bufSize = AC.sampleRate * 0.12;
    const buf = AC.createBuffer(1, bufSize, AC.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < bufSize; i++) data[i] = (Math.random()*2-1) * (1 - i/bufSize);
    const src = AC.createBufferSource();
    const filter = AC.createBiquadFilter();
    const og = AC.createGain();
    src.buffer = buf;
    filter.type = 'bandpass';
    filter.frequency.value = 800;
    filter.Q.value = 0.8;
    src.connect(filter); filter.connect(og); og.connect(AC.destination);
    og.gain.setValueAtTime(0.5, AC.currentTime);
    og.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + 0.12);
    src.start(AC.currentTime);
  }

  if (type === 'win') {
    // Fanfarra ascendente
    const notes = [330, 392, 494, 659];
    notes.forEach((freq, i) => {
      const o = AC.createOscillator();
      const og = AC.createGain();
      o.connect(og); og.connect(AC.destination);
      o.type = 'triangle';
      o.frequency.value = freq;
      og.gain.setValueAtTime(0, AC.currentTime + i*0.12);
      og.gain.linearRampToValueAtTime(0.25, AC.currentTime + i*0.12 + 0.04);
      og.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + i*0.12 + 0.3);
      o.start(AC.currentTime + i*0.12);
      o.stop(AC.currentTime + i*0.12 + 0.32);
    });
  }

  if (type === 'lose') {
    // Descendente triste
    const notes = [330, 277, 220];
    notes.forEach((freq, i) => {
      const o = AC.createOscillator();
      const og = AC.createGain();
      o.connect(og); og.connect(AC.destination);
      o.type = 'sawtooth';
      o.frequency.value = freq;
      og.gain.setValueAtTime(0, AC.currentTime + i*0.18);
      og.gain.linearRampToValueAtTime(0.15, AC.currentTime + i*0.18 + 0.05);
      og.gain.exponentialRampToValueAtTime(0.001, AC.currentTime + i*0.18 + 0.35);
      o.start(AC.currentTime + i*0.18);
      o.stop(AC.currentTime + i*0.18 + 0.37);
    });
  }
}

function initBoards() {
  myBoard  = Array.from({length: COLS}, () => Array(ROWS).fill(null));
  oppBoard = Array.from({length: COLS}, () => Array(ROWS).fill(null));
}

// â”€â”€ PEER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPeerID(code) { return 'knuckle-' + code.toUpperCase(); }

function checkPeer() {
  if (typeof Peer === 'undefined') { showToast('Biblioteca P2P carregando, aguarde...'); return false; }
  return true;
}

function createRoom() {
  if (!checkPeer()) return;
  myName = document.getElementById('player-name').value.trim();
  if (!myName) { showToast('Digite seu nome antes de continuar'); document.getElementById('player-name').focus(); return; }  roomCode = Math.random().toString(36).substring(2,6).toUpperCase();
  isHost   = true;

  showScreen('waiting');
  document.getElementById('display-room-code').textContent = roomCode;
  document.getElementById('room-label').textContent = 'Sala: ' + roomCode;

  peer = new Peer(getPeerID(roomCode), {debug: 0});
  peer.on('open', () => peer.on('connection', c => { conn = c; setupConn(); }));
  peer.on('error', e => showToast('Erro: ' + e.type));
}

function joinRoom() {
  if (!checkPeer()) return;
  const code = document.getElementById('room-code').value.trim().toUpperCase();
  myName = document.getElementById('player-name').value.trim();
  if (!myName) { showToast('Digite seu nome antes de continuar'); document.getElementById('player-name').focus(); return; }
  if (!code || code.length < 3) { showToast('Digite o cÃ³digo da sala'); return; }
  roomCode = code; isHost = false;

  showScreen('waiting');
  document.getElementById('display-room-code').textContent = code;
  document.getElementById('display-room-code').style.fontSize = '2rem';
  document.getElementById('room-label').textContent = 'Sala: ' + code;

  peer = new Peer(undefined, {debug: 0});
  peer.on('open', () => { conn = peer.connect(getPeerID(code)); setupConn(); });
  peer.on('error', () => { showToast('Sala nÃ£o encontrada ou erro'); backToLobby(); });
}

function setupConn() {
  conn.on('open',  () => send({type:'hello', name:myName}));
  conn.on('data',  handleMessage);
  conn.on('close', () => { if (gameStarted) showToast('Oponente desconectou'); });
}

function send(obj) { if (conn && conn.open) conn.send(obj); }

// â”€â”€ MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMessage(data) {
  switch (data.type) {
    case 'hello':
      oppName = data.name;
      document.getElementById('opp-name-display').textContent = oppName;
      if (isHost) { send({type:'start', oppName:myName}); startGame(true); }
      break;
    case 'start':
      oppName = data.oppName;
      document.getElementById('opp-name-display').textContent = oppName;
      startGame(false);
      break;
    case 'rolled': oppRolled(data.value); break;
    case 'placed': oppPlaced(data.col, data.value); break;
    case 'sync':   oppBoard = data.board; renderBoards(); break;
    case 'rematch-request':
      document.getElementById('rematch-btn-opp').style.display = 'block';
      document.getElementById('rematch-status').textContent = oppName + ' quer revanche!';
      break;
    case 'rematch-accept':
      document.getElementById('winner-overlay').classList.remove('active');
      rematchRequestedByMe = false;
      // host sempre vai primeiro, inverte a cada rematch
      startGame(true);
      break;
  }
}

// â”€â”€ GAME LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(goFirst) {
  initBoards();
  gameStarted = true;
  myTurn = goFirst;
  currentDie = null;
  document.getElementById('my-name-display').textContent  = myName;
  document.getElementById('opp-name-display').textContent = oppName;
  document.getElementById('room-label').textContent = 'Sala: ' + roomCode;
  showScreen('game');
  renderBoards();
  updateTurnUI();
  if (myTurn) setTimeout(rollMyDie, 600);
}

function rollMyDie() {
  if (!myTurn || currentDie !== null) return;
  currentDie = Math.ceil(Math.random() * 6);
  animateRoll(currentDie, () => {
    showRollingDie(currentDie);
    updateTurnUI();
    highlightColumns();
    send({type:'rolled', value:currentDie});
  });
}

function animateRoll(val, cb) {
  const c = document.getElementById('rolling-die-container');
  c.innerHTML = '<div class="rolling-die">?</div>';
  playSound('roll');
  let n = 0;
  const t = setInterval(() => {
    const el = c.querySelector('.rolling-die');
    if (el) el.textContent = Math.ceil(Math.random()*6);
    if (++n > 8) { clearInterval(t); cb(); }
  }, 60);
}

function showRollingDie(val) {
  document.getElementById('rolling-die-container').innerHTML =
    `<div class="rolling-die">${val}</div>`;
}

function clearRollingDie() {
  document.getElementById('rolling-die-container').innerHTML = '';
}

function oppRolled(val) {
  document.getElementById('rolling-die-container').innerHTML =
    `<div class="rolling-die" style="filter:grayscale(0.5);border-color:#666">${val}</div>`;
  document.getElementById('sub-status').textContent = oppName + ' estÃ¡ escolhendo...';
}

function highlightColumns() {
  document.getElementById('my-board').querySelectorAll('.board-col').forEach((col, i) => {
    if (myBoard[i].some(r => r === null)) {
      col.classList.add('selectable');
      col.onclick = () => placeInColumn(i);
    }
  });
}

function removeHighlights() {
  document.getElementById('my-board').querySelectorAll('.board-col').forEach(col => {
    col.classList.remove('selectable');
    col.onclick = null;
  });
}

function placeInColumn(colIdx) {
  if (!myTurn || currentDie === null) return;
  const col = myBoard[colIdx];
  const row = col.findIndex(r => r === null);
  if (row === -1) { showToast('Coluna cheia!'); return; }

  col[row] = currentDie;
  const val = currentDie;
  currentDie = null;
  myTurn = false;
  removeHighlights();
  clearRollingDie();
  playSound('place');
  cancelOppDice(colIdx, val);
  send({type:'placed', col:colIdx, value:val});
  send({type:'sync',   board:myBoard});
  renderBoards();
  if (!checkWin()) updateTurnUI();
}

function oppPlaced(colIdx, val) {
  const col = oppBoard[colIdx];
  const row = col.findIndex(r => r === null);
  if (row !== -1) col[row] = val;
  cancelMyDice(colIdx, val);
  clearRollingDie();
  renderBoards();
  myTurn = true;
  updateTurnUI();
  if (!checkWin()) setTimeout(rollMyDie, 500);
}

function cancelOppDice(ci, v) {
  const removed = oppBoard[ci].some(d => d === v);
  oppBoard[ci] = oppBoard[ci].map(d => d===v?null:d);
  compactCol(oppBoard[ci]);
  if (removed) playSound('cancel');
}
function cancelMyDice(ci, v)  { myBoard[ci]  = myBoard[ci].map(d => d===v?null:d);  compactCol(myBoard[ci]);  }
function compactCol(col) { const vals=col.filter(v=>v!==null); for(let i=0;i<ROWS;i++) col[i]=vals[i]??null; }

function calcColScore(col) {
  const f = col.filter(v=>v!==null);
  if (!f.length) return 0;
  const c={};
  f.forEach(v=>c[v]=(c[v]||0)+1);
  return Object.entries(c).reduce((s,[v,n])=>s+parseInt(v)*n*n, 0);
}
function calcTotalScore(board) { return board.reduce((s,col)=>s+calcColScore(col),0); }
function isGameOver() {
  return myBoard.every(col=>col.every(r=>r!==null)) ||
         oppBoard.every(col=>col.every(r=>r!==null));
}

function checkWin() {
  if (!isGameOver()) return false;
  const ms=calcTotalScore(myBoard), os=calcTotalScore(oppBoard);
  const winner = ms>os ? myName+' VENCEU!' : os>ms ? oppName+' VENCEU!' : 'EMPATE!';
  const emoji  = ms>os ? 'ğŸ†' : os>ms ? 'ğŸ’€' : 'ğŸ¤';
  setTimeout(() => {
    document.getElementById('trophy-emoji').textContent  = emoji;
    document.getElementById('winner-text').textContent   = winner;
    document.getElementById('winner-scores').textContent = `${myName}: ${ms}  â€¢  ${oppName}: ${os}`;
    document.getElementById('winner-overlay').classList.add('active');
    if (ms !== os) playSound(ms > os ? 'win' : 'lose');
  }, 600);
  return true;
}

function updateTurnUI() {
  document.getElementById('my-score').textContent  = calcTotalScore(myBoard);
  document.getElementById('opp-score').textContent = calcTotalScore(oppBoard);
  const el = document.getElementById('turn-status');
  document.getElementById('sub-status').textContent = '';
  if (myTurn) {
    el.textContent = currentDie!==null ? 'â–¼ Escolha uma coluna' : 'â–¼ Sua vez';
    el.style.color = '#e8c97a';
  } else {
    el.textContent = 'Vez de ' + oppName;
    el.style.color = '#888';
  }
}

// â”€â”€ RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBoards() {
  renderBoard('my-board',  myBoard,  true);
  renderBoard('opp-board', oppBoard, false);
  updateTurnUI();
}

function renderBoard(id, board, isMe) {
  const el = document.getElementById(id);
  el.innerHTML = '';
  for (let c=0; c<COLS; c++) {
    const col = document.createElement('div');
    col.className = 'board-col';
    col.dataset.col = c;

    const score = document.createElement('div');
    score.className = 'col-score';
    const cs = calcColScore(board[c]);
    score.textContent = cs>0 ? cs : '';

    if (!isMe) {
      col.appendChild(score);
      for (let r=ROWS-1; r>=0; r--) col.appendChild(makeDie(board[c][r]));
    } else {
      for (let r=ROWS-1; r>=0; r--) col.appendChild(makeDie(board[c][r]));
      col.appendChild(score);
    }
    el.appendChild(col);
  }
}

function makeDie(val) {
  const d = document.createElement('div');
  if (val === null) {
    d.className = 'die empty';
  } else {
    d.className = 'die ' + (val>=5 ? 'val-high' : val>=3 ? 'val-mid' : 'val-low');
    d.textContent = val;
  }
  return d;
}

// â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
}

function copyCode() {
  navigator.clipboard.writeText(roomCode)
    .then(() => showToast('CÃ³digo copiado!'))
    .catch(() => prompt('Copie o cÃ³digo:', roomCode));
}

function backToLobby() {
  if (peer) { try { peer.destroy(); } catch(e){} peer = null; }
  conn = null; gameStarted = false;
  showScreen('lobby');
}

function resetGame() {
  document.getElementById('winner-overlay').classList.remove('active');
  backToLobby();
}

function requestRematch() {
  rematchRequestedByMe = true;
  document.getElementById('rematch-status').textContent = 'Aguardando ' + oppName + '...';
  send({type: 'rematch-request'});
}

function acceptRematch() {
  send({type: 'rematch-accept'});
  document.getElementById('winner-overlay').classList.remove('active');
  rematchRequestedByMe = false;
  startGame(false);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// â”€â”€ EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('room-code').addEventListener('input', function() {
  this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
});
document.getElementById('room-code').addEventListener('keydown', e => { if(e.key==='Enter') joinRoom(); });
document.getElementById('player-name').addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('room-code').focus(); });
</script>
</body>
</html>